#!/bin/bash
# The Swarm v2.0 - CLI Wrapper
# Global command wrapper for the-swarm

set -e

SWARM_DIR="${SWARM_DIR:-$HOME/.swarm}"
CONFIG_DIR="${CONFIG_DIR:-$HOME/.swarm-config}"
VENV="$SWARM_DIR/venv"
AGENT="$SWARM_DIR/autonomous_agent.py"
CONFIG_FILE="$CONFIG_DIR/config.json"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Help function
show_help() {
    cat << 'EOF'
The Swarm v2.0 - Multi-Model Collaborative Agent

Usage:
  swarm "<task>"              Run a task in swarm mode
  swarm --offline "<task>"    Run without downloading models
  swarm --model <name> "<task>"  Use specific model
  swarm                       Interactive mode
  swarm config                Show config
  swarm config set <key> <val>  Set config option
  swarm models                List installed models
  swarm models download <n>   Download a model
  swarm models cleanup        Remove unused models
  swarm hardware              Show hardware info
  swarm update                Update to latest version
  swarm --help                Show this help

Examples:
  swarm "Create a hello_world function"
  swarm --offline "Create fibonacci"
  swarm --model qwen2.5-coder:3b "Complex task"
  swarm config set offline_mode true

Config file: ~/.swarm-config/config.json
EOF
    exit 0
}

# Check if installed
check_install() {
    if [[ ! -f "$AGENT" ]]; then
        echo -e "${RED}Error: The Swarm is not installed.${NC}"
        echo "Install with: curl -sSL https://raw.githubusercontent.com/Xzeroone/The_Swarm/main/install.sh | bash"
        exit 1
    fi
}

# Get config value
get_config() {
    local key="$1"
    if [[ -f "$CONFIG_FILE" ]]; then
        python3 -c "import json; print(json.load(open('$CONFIG_FILE')).get('$key', ''))" 2>/dev/null || echo ""
    fi
}

# Set config value
set_config() {
    local key="$1"
    local value="$2"
    if [[ -f "$CONFIG_FILE" ]]; then
        python3 << PYEOF
import json
with open("$CONFIG_FILE") as f:
    config = json.load(f)

value = "$value"
if value.lower() == "true":
    config["$key"] = True
elif value.lower() == "false":
    config["$key"] = False
elif value.isdigit():
    config["$key"] = int(value)
else:
    config["$key"] = value

with open("$CONFIG_FILE", "w") as f:
    json.dump(config, f, indent=2)
print(f"✓ Set $key = {config['$key']}")
PYEOF
    else
        echo "Config file not found: $CONFIG_FILE"
    fi
}

# Show config
show_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        cat "$CONFIG_FILE"
    else
        echo "Config file not found: $CONFIG_FILE"
    fi
}

# List models
list_models() {
    echo "Installed models:"
    echo ""
    ollama list | tail -n +2 | while read line; do
        model=$(echo "$line" | awk '{print $1}')
        size=$(echo "$line" | awk '{print $3}')
        echo "  • $model ($size)"
    done
    echo ""
    echo "Configured models:"
    echo "  Default: $(get_config default_model)"
    echo "  Router: $(get_config router_model)"
}

# Download model
download_model() {
    local model="$1"
    if [[ -z "$model" ]]; then
        echo "Usage: swarm models download <model-name>"
        echo "Example: swarm models download qwen2.5-coder:1.5b"
        exit 1
    fi
    echo "Downloading $model..."
    ollama pull "$model"
}

# Cleanup models
cleanup_models() {
    echo "Cleaning up unused models..."
    python3 << 'PYEOF'
import json
import subprocess
from pathlib import Path

config_file = Path.home() / ".swarm-config" / "config.json"
if config_file.exists():
    config = json.loads(config_file.read_text())
    keep_models = [config.get("default_model"), config.get("router_model")]
    keep_models = [m for m in keep_models if m]
    
    # Get swarm-downloaded models
    registry_file = Path.home() / ".swarm" / "model_registry.json"
    if registry_file.exists():
        registry = json.loads(registry_file.read_text())
        for model in registry.get("downloaded_by_swarm", []):
            if model not in keep_models:
                print(f"  Removing: {model}")
                subprocess.run(["ollama", "rm", model], capture_output=True)
PYEOF
    echo "✓ Cleanup complete"
}

# Show hardware info
show_hardware() {
    python3 << 'PYEOF'
import psutil
import json
from pathlib import Path

ram = psutil.virtual_memory()
disk = psutil.disk_usage("/")

print(f"Hardware Info:")
print(f"  RAM: {ram.total / (1024**3):.1f}GB total, {ram.available / (1024**3):.1f}GB available")
print(f"  CPU cores: {psutil.cpu_count()}")
print(f"  Free disk: {disk.free / (1024**3):.1f}GB")

config_file = Path.home() / ".swarm-config" / "config.json"
if config_file.exists():
    config = json.loads(config_file.read_text())
    print(f"\nConfigured profile: {config.get('hardware_profile', 'unknown')}")
    print(f"Default model: {config.get('default_model', 'unknown')}")
PYEOF
}

# Update swarm
update_swarm() {
    echo "Updating The Swarm..."
    cd "$SWARM_DIR"
    git pull
    source "$VENV/bin/activate"
    pip install --quiet -r requirements.txt
    echo "✓ Update complete"
}

# Parse arguments
OFFLINE=""
MODEL=""
TASK=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            show_help
            ;;
        --offline)
            OFFLINE="--offline"
            shift
            ;;
        --model|-m)
            MODEL="$2"
            shift 2
            ;;
        config)
            shift
            if [[ "$1" == "set" ]]; then
                shift
                set_config "$1" "$2"
                exit 0
            else
                show_config
                exit 0
            fi
            ;;
        models)
            shift
            case $1 in
                download)
                    download_model "$2"
                    exit 0
                    ;;
                cleanup)
                    cleanup_models
                    exit 0
                    ;;
                *)
                    list_models
                    exit 0
                    ;;
            esac
            ;;
        hardware)
            show_hardware
            exit 0
            ;;
        update)
            update_swarm
            exit 0
            ;;
        -*)
            echo "Unknown option: $1"
            echo "Run 'swarm --help' for usage"
            exit 1
            ;;
        *)
            TASK="$1"
            shift
            ;;
    esac
done

# Run the agent
check_install

# Activate venv and run
source "$VENV/bin/activate"

# Build command
CMD="python3 $AGENT --swarm"

if [[ -n "$OFFLINE" ]]; then
    CMD="$CMD $OFFLINE"
fi

if [[ -n "$MODEL" ]]; then
    CMD="$CMD --model $MODEL"
fi

if [[ -n "$TASK" ]]; then
    CMD="$CMD -d \"$TASK\""
fi

eval "$CMD"
